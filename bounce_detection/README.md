# ç¾½æ¯›çƒäº‹ä»¶æ£€æµ‹æ¨¡å—

**Badminton Event Detection Module**

æ£€æµ‹ç¾½æ¯›çƒæ¯”èµ›ä¸­çš„å…³é”®äº‹ä»¶ï¼šè½åœ°ç‚¹ (Landing) å’Œå‡»çƒç‚¹ (Hit)ã€‚

---

## ğŸ“‹ æ¨¡å—æ¦‚è§ˆ

æœ¬æ¨¡å—æ˜¯ TrackNetV3 çš„åå¤„ç†æ‰©å±•ï¼ŒåŸºäºè½¨è¿¹åæ ‡æ£€æµ‹ç¾½æ¯›çƒçš„å…³é”®äº‹ä»¶ã€‚

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Bounce Detection Module                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   Phase 1: è§„åˆ™æ£€æµ‹ (Rule-Based)          Phase 2: æ·±åº¦å­¦ä¹ åˆ†ç±»          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚  KinematicsCalculator       â”‚        â”‚  VisualFeatureExtractor     â”‚â”‚
â”‚   â”‚  â”œâ”€â”€ é€Ÿåº¦/åŠ é€Ÿåº¦è®¡ç®—        â”‚        â”‚  â”œâ”€â”€ Patch æå–             â”‚â”‚
â”‚   â”‚  â””â”€â”€ è¿åŠ¨æ–¹å‘/æ›²ç‡          â”‚        â”‚  â””â”€â”€ è¿åŠ¨å†å²å›¾ (MHI)       â”‚â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚   â”‚  BounceCandidateGenerator   â”‚        â”‚  BounceNet                  â”‚â”‚
â”‚   â”‚  â”œâ”€â”€ 7 æ¡æ£€æµ‹è§„åˆ™           â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  â”œâ”€â”€ è½¨è¿¹ç¼–ç å™¨ (LSTM)      â”‚â”‚
â”‚   â”‚  â””â”€â”€ å€™é€‰äº‹ä»¶ç”Ÿæˆ           â”‚        â”‚  â”œâ”€â”€ è§†è§‰ç¼–ç å™¨ (CNN)       â”‚â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚  â””â”€â”€ èåˆåˆ†ç±»å™¨             â”‚â”‚
â”‚   â”‚  BounceDetector             â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚   â”‚  â””â”€â”€ ç»Ÿä¸€æ£€æµ‹æ¥å£           â”‚                                       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                          â”‚
â”‚   è¾…åŠ©å·¥å…·:                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚  LabelingTool               â”‚        â”‚  BounceNetDataset           â”‚â”‚
â”‚   â”‚  â””â”€â”€ åŠè‡ªåŠ¨æ ‡æ³¨ç•Œé¢         â”‚        â”‚  â””â”€â”€ è®­ç»ƒæ•°æ®åŠ è½½           â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äº‹ä»¶ç±»å‹

| äº‹ä»¶ç±»å‹ | æ ‡è¯† | æè¿° |
|---------|------|------|
| **è½åœ°ç‚¹** | `landing` | çƒè½åœ°ååœæ­¢æˆ–æ¶ˆå¤± |
| **å‡»çƒç‚¹** | `hit` | çƒè¢«çƒæ‹å‡»ä¸­ï¼Œæ–¹å‘åè½¬ |
| **å‡ºç”»é¢** | `out_of_frame` | çƒé£å‡ºç”»é¢è¾¹ç¼˜ |
| **éäº‹ä»¶** | `none` | BounceNet è¿‡æ»¤çš„è¯¯æ£€ |

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
bounce_detection/
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶ - æ¨¡å—æ€»è§ˆ
â”œâ”€â”€ README_phase1_rules.md       # Phase 1 è§„åˆ™æ£€æµ‹è¯¦ç»†æ–‡æ¡£
â”‚
â”œâ”€â”€ __init__.py                  # æ¨¡å—å…¥å£ï¼Œå¯¼å‡ºæ‰€æœ‰å…¬å…± API
â”œâ”€â”€ kinematics.py                # è¿åŠ¨å­¦ç‰¹å¾è®¡ç®—
â”œâ”€â”€ candidate_generator.py       # è§„åˆ™æ£€æµ‹ + å€™é€‰ç”Ÿæˆ
â”œâ”€â”€ detector.py                  # ç»Ÿä¸€æ£€æµ‹å™¨æ¥å£
â”‚
â”œâ”€â”€ visual_features.py           # è§†è§‰ç‰¹å¾æå– (Phase 2)
â”œâ”€â”€ bouncenet.py                 # BounceNet åˆ†ç±»ç½‘ç»œ (Phase 2)
â”œâ”€â”€ dataset.py                   # è®­ç»ƒæ•°æ®é›† (Phase 2)
â”‚
â””â”€â”€ labeling/                    # æ ‡æ³¨å·¥å…·å­æ¨¡å—
    â”œâ”€â”€ README_labeling_tool.md  # æ ‡æ³¨å·¥å…·è¯¦ç»†æ–‡æ¡£
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ data_manager.py          # æ•°æ®ç®¡ç†
    â”œâ”€â”€ visualizer.py            # å¯è§†åŒ–ç»„ä»¶
    â””â”€â”€ labeling_tool.py         # æ ‡æ³¨å·¥å…·ä¸»ç±»
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
pip install numpy pandas matplotlib torch opencv-python
```

### Phase 1: è§„åˆ™æ£€æµ‹

```python
from bounce_detection import BounceDetector

# åˆå§‹åŒ–æ£€æµ‹å™¨
detector = BounceDetector()

# ä» CSV æ–‡ä»¶æ£€æµ‹
events = detector.detect_from_csv('data/test/match1/csv/1_05_02_ball.csv')

for event in events:
    print(f"Frame {event['frame']:4d} | {event['event_type']:12s} | Rule: {event['rule']}")
```

### Phase 2: å¸¦ BounceNet çš„æ£€æµ‹

```python
from bounce_detection import BounceDetector

# åŠ è½½å¸¦ BounceNet çš„æ£€æµ‹å™¨
detector = BounceDetector(bouncenet_ckpt='ckpts/bouncenet/best.pt')

# æ£€æµ‹å¹¶è¿‡æ»¤è¯¯æ£€
events = detector.detect(x, y, visibility, use_bouncenet=True)
```

### æ ‡æ³¨å·¥å…·

```bash
# å•æ–‡ä»¶æ ‡æ³¨
python labeling_launcher.py --csv data/test/match1/csv/1_05_02_ball.csv

# æ‰¹é‡æ ‡æ³¨
python labeling_launcher.py --match_dir data/test/match1/csv
```

---

## ğŸ“– è¯¦ç»†æ–‡æ¡£

| æ–‡æ¡£ | å†…å®¹ |
|------|------|
| [README_phase1_rules.md](README_phase1_rules.md) | Phase 1 è§„åˆ™æ£€æµ‹ï¼šè¿åŠ¨å­¦è®¡ç®—ã€7æ¡æ£€æµ‹è§„åˆ™ã€å‚æ•°é…ç½® |
| [README_phase2_bouncenet.md](README_phase2_bouncenet.md) | Phase 2 BounceNetï¼šç½‘ç»œæ¶æ„ã€ç‰¹å¾æå–ã€è®­ç»ƒæµç¨‹ |
| [labeling/README_labeling_tool.md](labeling/README_labeling_tool.md) | æ ‡æ³¨å·¥å…·ï¼šç•Œé¢ä½¿ç”¨ã€å¿«æ·é”®ã€æ•°æ®æ ¼å¼ |

---

## ğŸ”§ API å‚è€ƒ

### æ ¸å¿ƒç±»

```python
from bounce_detection import (
    # Phase 1
    BounceDetector,           # ç»Ÿä¸€æ£€æµ‹å™¨
    KinematicsCalculator,     # è¿åŠ¨å­¦è®¡ç®—
    BounceCandidateGenerator, # å€™é€‰ç”Ÿæˆ
    
    # Phase 2
    BounceNet,                # åˆ†ç±»ç½‘ç»œ
    BounceNetPredictor,       # æ¨ç†åŒ…è£…å™¨
    VisualFeatureExtractor,   # è§†è§‰ç‰¹å¾
    
    # å¸¸é‡
    EVENT_LABELS,             # {'none': 0, 'landing': 1, 'hit': 2}
    LABEL_TO_EVENT,           # {0: 'none', 1: 'landing', 2: 'hit'}
)
```

### BounceDetector

```python
class BounceDetector:
    def __init__(self,
                 fps: int = 30,
                 bouncenet_ckpt: str = None,    # BounceNet æ£€æŸ¥ç‚¹è·¯å¾„
                 use_visual_features: bool = False):
        ...
    
    def detect(self, x, y, visibility, 
               frames=None,              # è§†é¢‘å¸§åˆ—è¡¨ (Phase 2)
               use_bouncenet=True) -> List[Dict]:
        """æ£€æµ‹äº‹ä»¶"""
    
    def detect_from_csv(self, csv_path) -> List[Dict]:
        """ä» CSV æ–‡ä»¶æ£€æµ‹"""
```

### BounceNet

```python
class BounceNet:
    def __init__(self,
                 mode: str = 'trajectory_only',  # 'trajectory_only', 'visual_only', 'fusion'
                 num_classes: int = 3):
        ...
    
    def forward(self, traj_features, visual_features=None):
        """å‰å‘ä¼ æ’­"""
    
    def predict(self, traj_features, visual_features=None) -> Dict:
        """é¢„æµ‹ï¼Œè¿”å› labels, probs, confidence"""
```

---

## ğŸ“Š æ£€æµ‹è§„åˆ™ä¸€è§ˆ

| è§„åˆ™ | äº‹ä»¶ç±»å‹ | ç½®ä¿¡åº¦ | æè¿° |
|------|---------|--------|------|
| `vy_reversal` | hit | 0.80 | Yæ–¹å‘é€Ÿåº¦åè½¬ |
| `vx_reversal` | hit | 0.75 | Xæ–¹å‘é€Ÿåº¦åè½¬ |
| `y_local_min` | hit | 0.70 | Yåæ ‡å±€éƒ¨æå°å€¼ï¼ˆæœ€é«˜ç‚¹ï¼‰ |
| `speed_local_max` | hit | 0.65 | é€Ÿåº¦å±€éƒ¨æå¤§å€¼ |
| `visibility_drop` | landing | 0.85 | åœºå†…å¯è§æ€§æ¶ˆå¤± |
| `speed_drop` | landing | 0.75 | é€Ÿåº¦éª¤é™ |
| `trajectory_end` | landing | 0.70 | è½¨è¿¹ç»“æŸ |
| `visibility_drop_edge` | out_of_frame | 0.50 | è¾¹ç¼˜å¯è§æ€§æ¶ˆå¤± |

---

## ğŸ‹ï¸ è®­ç»ƒ BounceNet

```bash
# ä½¿ç”¨æ ‡æ³¨æ•°æ®è®­ç»ƒ
python train_bouncenet.py \
    --label_dir labels/ \
    --mode trajectory_only \
    --epochs 100 \
    --batch_size 32 \
    --lr 1e-3

# ä½¿ç”¨èåˆæ¨¡å¼ï¼ˆéœ€è¦è§†é¢‘ï¼‰
python train_bouncenet.py \
    --label_dir labels/ \
    --mode fusion \
    --epochs 100
```

è¯¦è§ [README_phase2_bouncenet.md](README_phase2_bouncenet.md)

---

## ğŸ“ˆ å·¥ä½œæµç¨‹

```
1. TrackNetV3 æ£€æµ‹          2. Phase 1 è§„åˆ™æ£€æµ‹         3. äººå·¥æ ‡æ³¨
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Video       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Candidates  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Ground Truthâ”‚
   â”‚ â†’ CSV       â”‚            â”‚ (é«˜å¬å›ç‡)   â”‚            â”‚ (JSON)      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                â”‚
                                                                â–¼
4. è®­ç»ƒ BounceNet           5. Phase 2 æ£€æµ‹             6. æœ€ç»ˆç»“æœ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ BounceNet   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Candidates  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Filtered    â”‚
   â”‚ æ¨¡å‹è®­ç»ƒ     â”‚            â”‚ + BounceNet â”‚            â”‚ Events      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **v2.0** (2026-01-21): æ·»åŠ  BounceNet æ·±åº¦å­¦ä¹ åˆ†ç±»
  - æ–°å¢ `VisualFeatureExtractor` è§†è§‰ç‰¹å¾æå–
  - æ–°å¢ `BounceNet` åˆ†ç±»ç½‘ç»œï¼ˆæ”¯æŒ trajectory/visual/fusion ä¸‰ç§æ¨¡å¼ï¼‰
  - æ–°å¢ `BounceNetDataset` å’Œè®­ç»ƒè„šæœ¬
  - æ›´æ–° `BounceDetector` æ”¯æŒ BounceNet é›†æˆ

- **v1.1** (2026-01-20): å¢å¼ºè§„åˆ™æ£€æµ‹
  - æ–°å¢è§„åˆ™ 5: `y_local_min` (Yåæ ‡å±€éƒ¨æå°å€¼)
  - æ–°å¢è§„åˆ™ 6: `speed_local_max` (é€Ÿåº¦å±€éƒ¨æå¤§å€¼)
  - å€™é€‰å¬å›ç‡æå‡ ~29%

- **v1.0** (2026-01-19): åˆå§‹ç‰ˆæœ¬
  - Phase 1 è§„åˆ™æ£€æµ‹å®ç°
  - åŠè‡ªåŠ¨æ ‡æ³¨å·¥å…·
